WITH TRIPS_MADE AS(
  SELECT TRIP_ID, LOCATION_TYPE,
  ROW_NUMBER() OVER (PARTITION BY TRIP_ID ORDER BY EVENT_TIME) AS START_TYM,
  ROW_NUMBER() OVER (PARTITION BY TRIP_ID ORDER BY EVENT_TIME DESC) AS END_TYM
  FROM TRIPS
) 
SELECT TRIP_ID FROM TRIPS_MADE WHERE START_TYM =1 AND LOCATION_TYPE ='MANUFACTURING'
INTERSECT
SELECT TRIP_ID FROM TRIPS_MADE WHERE END_TYM =1 AND LOCATION_TYPE ='RETAIL';
